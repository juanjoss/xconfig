# xconfig

xconfig is an environment repository for [x](https://github.com/juanjoss/x).

This repository demostrates a CI/CD GitOps workflow using Github Actions, ArgoCD and Terraform.

## Wokflow

The workflow is based on a [Pull-based GitOps Deployment](https://www.gitops.tech/#pull-based-deployments) model.

![gitops-pull-workflow](https://www.gitops.tech/images/pull.png)

This is the generalized process.

![gitops-drawing](https://drive.google.com/uc?export=view&id=1C_l4QyrXXulz2zTssrHBg6CfDJ7f-DAM)

1. The `CI pipeline` configured in `x` is triggered on a push and performs the following steps:

    - Tests using the Go tooling.
    
    - Builds and pushes the container image to ghcr using Docker.

    - Updates the kubernetes manifests files inside `xconfig` using kustomize.

2. A GKE cluster provisioned using Terraform will host `x`. The ArgoCD operator will sync `xconfig` and deploy the app using the manifests generated by the CI pipeline.

    - Provision the kubernetes cluster.
    
        ```bash
        terraform -chdir=terraform/ init
        terraform -chdir=terraform/ validate
        terraform -chdir=terraform/ plan
        terraform -chdir=terraform/ apply -auto-approve
        ```
    
    By default terraform will install ArgoCD inside the cluster over its own namespace. But if you want to know how to manually install it you can check the [docs](https://argo-cd.readthedocs.io/en/stable/getting_started/#requirements).

    - Deploy and access `x`.

        ```bash
        kubectl -n argocd apply -f ./argocd/application.yaml
        ```
        This will tell ArgoCD to sync with `xconfig` and start watching changes inside the `/manifests` directory in this repo.

        Now a new namespace (dev) should be created with `x` resources inside it, and it should be accesible (using port forwarding in this case).
        ```bash
        # namespace "dev" should exist
        kubectl get ns

        # check out x resources
        kubectl -n dev get all
        
        # use port forwarding to access x
        kubectl -n dev port-forward svc/x 8080:8080

        # get the default admin password and access the ArgoCD UI
        kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d; echo

        kubectl -n argocd port-forward svc/argocd-server 8080:443
        ```